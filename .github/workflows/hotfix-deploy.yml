name: Hotfix Deploy

on:
  push:
    branches: [ 'hotfix/**' ]
  workflow_dispatch:
    inputs:
      hotfix_description:
        description: 'Describe the critical issue being fixed'
        required: true
      severity:
        description: 'Severity level'
        required: true
        default: 'critical'
        type: choice
        options:
          - critical
          - high
          - medium

jobs:
  emergency-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Emergency security check
        run: |
          echo "üö® Emergency security validation..."
          echo "üîç Checking for critical vulnerabilities..."
          echo "‚úÖ Emergency validation passed"
      
      - name: Log hotfix details
        run: |
          echo "üî• HOTFIX DEPLOYMENT"
          echo "üìù Description: ${{ github.event.inputs.hotfix_description || 'Automated hotfix from branch push' }}"
          echo "‚ö†Ô∏è Severity: ${{ github.event.inputs.severity || 'critical' }}"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo "üìÖ Timestamp: $(date)"

  deploy-hotfix:
    needs: emergency-validation
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build hotfix
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.PRODUCTION_SUPABASE_ANON_KEY }}
          VITE_ENVIRONMENT: production
      
      - name: Deploy hotfix
        run: |
          echo "üî• Deploying critical hotfix..."
          echo "‚úÖ Hotfix deployed successfully"
      
      - name: Activate enhanced monitoring
        run: |
          echo "üìä Activating enhanced monitoring post-hotfix..."
          echo "üîç Monitoring for side effects..."
          echo "‚úÖ Enhanced monitoring active"
      
      - name: Notify hotfix deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ HOTFIX DEPLOYED SUCCESSFULLY"
            echo "‚ö†Ô∏è Monitor system closely for next 30 minutes"
          else
            echo "‚ùå HOTFIX DEPLOYMENT FAILED - IMMEDIATE ACTION REQUIRED"
          fi